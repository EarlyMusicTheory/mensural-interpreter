---
layout: interpreter
title: Interpreter
---
<!-- Navigation -->
<nav class="navbar navbar-dark bg-dark navbar-expand-md">
    <a class="navbar-brand" href="#">EMT rocks!</a>
    <div class="navbar-nav mr-auto">
        <div class="dropdown col-4 mr-1">
            <button class="btn btn-secondary dropdown-toggle" id="fileDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Load
            </button>
            <div class="dropdown-menu p-2 w-100" aria-labelledby="fileDropdown">
                <label for="fileInput">Load local MEI file</label>
                <form class="custom-file p-2" id="fileInput">
                    <label class="custom-file-label" for="customFile">File</label>
                    <input type="file" class="custom-file-input" id="customFile">
                </form>
                <button id="btnResetFile" class="btn btn-primary">
                    Reset
                </button>
                <div class="dropdown-divider"></div>
                <label for="urlInput">Load MEI from URI</label>
                <div class="input-group mb-1" id="urlInput">
                    <input id="url" class="form-control" type="url" placeholder="URL">
                    <div class="input-group-append">
                        <button id="load" type="submit" class="btn btn-outline-secondary">Load</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="btn-group mr-2" role="group" aria-label="Scroll">
        <button id="vrvZoomIn" type="button" class="btn btn-secondary">In</button>
        <button id="vrvZoomOut" type="button" class="btn btn-secondary">Out</button>
    </div>
    <div class="btn-group" role="group" aria-label="Scroll">
        <button id="vrvBack" type="button" class="btn btn-secondary">&lt;&lt;</button>
        <button id="vrvPageN" type="button" class="btn btn-light">0/0</button>
        <button id="vrvForw" type="button" class="btn btn-secondary">&gt;&gt;</button>
    </div>
</nav>

<!-- Content -->
<div class="container-fluid">
   <div class="row">
        <div id="side" class="col-2 bg-light">
            <h2>Note attributes</h2>
            <div id="elementInfo"></div>
        </div>
        <div class="col-10">
            <div id="vrvOutput"></div>
        </div>
   </div>
</div>

<script  type="text/javascript">
    var vrv = new verovio.toolkit();
    var currentUrl = new URL(window.location.href);
    var baseUrl = currentUrl.origin + currentUrl.pathname;
    var currentParams = currentUrl.searchParams;
    var meiUrl;
    var meiFile;
    var zoom = 50;
    var pageHeight = 2970;
    var pageWidth = 2100;
    var page = 1;
    var svg;
    //var mei;


    function fetchMEI(meiUrl) {
        if(meiUrl)
        {
            fetch(meiUrl)
            .then(function(response) {
                return response.text();
            })
            .then(function(text) {
                meiFile = text;
                loadData(text);
            });
        }
    }

    function setOptions() {
        pageHeight = $(document).height() * 100 / zoom ;
        pageWidth = ($(window).width() - ($("#side").width() * 1.2) ) * 100 / zoom ;
        options = {
                    pageHeight: pageHeight,
                    pageWidth: pageWidth,
                    scale: zoom,
                    adjustPageHeight: true
                };
        vrv.setOptions(options);
    }

    function loadData (data) {
        setOptions();
        vrv.loadData(data);
        loadPage();
        bindInteractionEvents();
    }
    
    function loadPage() {
        $("#vrvPageN").html(page + "/" + vrv.getPageCount());

        svg = vrv.renderToSVG(page, {});
        $("#vrvOutput").html(svg);
        bindInteractionEvents();
        //adjust_page_height();
        
    };

    function nextPage() {
        if (page >= vrv.getPageCount()) {
            return;
        }

        page = page + 1;
        loadPage();
    };

    function prevPage() {
        if (page <= 1) {
            return;
        }

        page = page - 1;
        loadPage();
    };

    function applyZoom() {
        setOptions();
        vrv.redoLayout();

        page = 1;
        loadPage();
    }

    function zoomOut() {
        if (zoom < 20) {
            return;
        }
        zoom = zoom / 2;
        applyZoom();
    };   

    function zoomIn() {
        if (zoom > 80) {
            return;
        }
        zoom = zoom * 2;
        applyZoom();
    };


    function bindInteractionEvents() {
        /* Super fancy music interaction */
        // Highlight notes on mouseover
        $(".note").mouseover(function() {
            $(this).attr("fill", "#007bff");
        });

        // Click shows element information in sidebar
        $(".note").click(function() {
            let thisID = $(this).attr("id");
            let thisElementAttrs = vrv.getElementAttr(thisID);

            let elementInfo = $("<ul></ul>");

            for (const [key, value] of Object.entries(thisElementAttrs)) {
                let attr = $("<li></li>").text(`${key}: ${value}`);
                $(elementInfo).append(attr);
            }

            $("#elementInfo").html(elementInfo);
        });

        // Remove highlighting on mouseout
        $(".note").mouseout(function() {
            $(this).attr("fill", "#000");
        });
    };
    
    $(document).ready(function(){

        meiUrl = currentParams.get("url");
        if(meiUrl) 
        {
            fetchMEI(meiUrl);
        }
        
        // fancy file input animation
        bsCustomFileInput.init()

        $("#customFile").change(function() {
            let meiBlob = this.files[0];

            var reader = new FileReader();
            reader.readAsText(meiBlob);

            reader.onload = function(event) {
                meiFile = event.target.result;
                currentParams.set("url", null);
                window.history.pushState({}, "Mensural interpreter", `${baseUrl}`);
                loadData(event.target.result);
            };    
        });

        $("#btnResetFile").click(function() {
            $("#fileInput")[0].reset();
        });
        
        $("#load").click(function() {
            let input = $("#url").val();
            currentParams.set("url", input);
            location.replace(`${baseUrl}?${currentParams}`);
            return false;
        });

        $("#vrvForw").click(function() {
            nextPage();
        });
        $("#vrvBack").click(function() {
            prevPage();
        });

        $("#vrvZoomIn").click(function() {
            zoomIn();
        });

        $("#vrvZoomOut").click(function() {
            zoomOut();
        });

        $(window).resize(function(){
            applyZoom();
        });

        $("#elementInfo").click(function() {
            $(this).empty();
        });

    });
</script>